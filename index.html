<!DOCTYPE html>
<html>
    <head>
        <script src="book.js">
            var newbook = new book("Name", "Author", 1997);
            console.log(newbook.getName())
        </script>

        <style>label{display: inline-block; width: 80px}</style>
    </head>
    <body>
        <header class="header">
            <h1>My Library</h1>
            <div class="logIn">
              <button class="btn" id="logInBtn">Login</button>
            </div>
            <div class="logOut">
              <button class="btn" id="logOutBtn">Log out</button>
            </div>
        </header>

        <label>Name</label> <input id="NameBox" type="text">
        <label>Author</label> <input id="AuthorBox" type="text">
        <label>Year Published</label> <input id="YearBox" type="text">



        
        <br>
        <button id="addBookBtn" type="button"> Add new Book</button>
        <br>
        <button id="findBookBtn" type="button">Find Book</button>
        <br>
        <button id="removeBookBtn" type="button">Remove Book</button>
        <p id="bookName">Enter above to add, remove, or find a book!</p>
        <br>
        <p id="bookAuthor"></p>
        <br>
        <p id="bookYear"></p>
        <br>
        <p id="bookCopies"></p>

          

          
    </body>
    <script type="module">
            
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, update, DataSnapshot, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth-compat.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDomy_iTgvqoDAFqJmU1sjLditwOKFdf_o",
          authDomain: "cpsc254library.firebaseapp.com",
          projectId: "cpsc254library",
          storageBucket: "cpsc254library.appspot.com",
          messagingSenderId: "783490531388",
          appId: "1:783490531388:web:bfe47ed7a478703f52c339",
          measurementId: "G-T5TJPH6M0G",
          //databaseURL: "https://cpsc254library-default-rtdb.firebaseio.com"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase();
        const auth = getAuth(app);

        
        var addBookButton = document.getElementById("addBookBtn");
        var findBookButton = document.getElementById("findBookBtn");
        var removeBookButton = document.getElementById("removeBookBtn");


        var name = document.getElementById("NameBox");
        var author = document.getElementById("AuthorBox");
        var year = document.getElementById("YearBox");
        var copies = 0;
        //console.log(copies);
        
        function addBook(){
            //console.log("start");
            //const copiesCountRef = ref(database, "Books/" + name.value +'/copies');
            //copiesCountRef.runTransaction(function(copies){
            //  console.log(copies)
            //})
            if(name.value == "" || author.value == "" || year.value ==""){
                document.getElementById("bookName").innerHTML = "All values must be filled...";
                document.getElementById("bookAuthor").innerHTML = "";
                document.getElementById("bookYear").innerHTML = "";
                document.getElementById("bookCopies").innerHTML = "";
            }
            else{


            
   
            get(child(ref(database), 'Books/'+ name.value +'/copies')).then((snapshot)=>{
                console.log("get");
                if(snapshot.exists()){
                    console.log(snapshot.val());
                    copies = snapshot.val() + 1; 
                }
                else{
                    console.log("Empty")
                    copies = 1;
                }

                console.log("set");
                set(ref(database, 'Books/' + name.value), {
                    author: author.value,
                    year: year.value,
                    copies: copies
                })
                .then(()=>{
                    console.log("Book Added")
                })
                .catch((error)=>{
                    alert("unsuccessful");
                    //console.log(error);
                })


            }).catch((error)=>{
                console.error(error);
            })
     /*    
            set(ref(database, 'Authors/' + author.value), {
                Books: name.value
            })

            set(ref(database, 'Years/' + year.value ), {
                1: name.value
            })
*/          //console.log("set");
            //getCopies(name.value);
            

        //console.log("end");

            }
        }

        function findBook(){
            if(name.value == ""){
                document.getElementById("bookName").innerHTML = "Name must be filled...";
                document.getElementById("bookAuthor").innerHTML = "";
                document.getElementById("bookYear").innerHTML = "";
                document.getElementById("bookCopies").innerHTML = "";
            }
            else{
            const dbref = ref(database)
            get(child(dbref, 'Books/' + name.value)).then((snapshot)=> {
                if(snapshot.exists()){
                    console.log(snapshot.val());
                    document.getElementById("bookName").innerHTML = "Name: " + name.value;
                    document.getElementById("bookAuthor").innerHTML = "Author: " + snapshot.val().author;
                    document.getElementById("bookYear").innerHTML = "Year Published: " + snapshot.val().year;
                    document.getElementById("bookCopies").innerHTML = "Copies Available: " + snapshot.val().copies;
                }
                else{
                    console.log("Unavailable")
                    document.getElementById("bookName").innerHTML = "Unavailable";
                    document.getElementById("bookAuthor").innerHTML = "";
                    document.getElementById("bookYear").innerHTML = "";
                    document.getElementById("bookCopies").innerHTML = "";
                }
            }).catch((error) => {
                console.error(error);
            })
        }
        }

        function removeBook(){
            if(name.value == ""){
                document.getElementById("bookName").innerHTML = "Name must be filled...";
                document.getElementById("bookAuthor").innerHTML = "";
                document.getElementById("bookYear").innerHTML = "";
                document.getElementById("bookCopies").innerHTML = "";
            }
            else{
                
                get(child(ref(database), 'Books/'+ name.value)).then((snapshot)=>{
                console.log("get");
                if(snapshot.exists()){
                    console.log(snapshot.val().copies);
                    copies = snapshot.val().copies; 
                }
                else{
                    console.log("Empty")
                }

                if(copies == 0){
                    console.log("No More Copies")
                }
                else{
                copies -= 1;
                console.log("set");
                set(ref(database, 'Books/' + name.value), {
                    author: snapshot.val().author,
                    year: snapshot.val().year,
                    copies: copies
                })
                .then(()=>{
                    console.log("Book Removed");
                })
                .catch((error)=>{
                    alert("unsuccessful");
                    //console.log(error);
                })

            }
            }).catch((error)=>{
                console.error(error);
            })
            }
        }
/*
        function getCopies(name){
            console.log(name.value)
            get(child(ref(database), 'Books/'+ name.value +'/copies')).then((snapshot)=>{
                if(snapshot.exists()){
                    console.log("Num of Copies = " + snapshot.val())      
                }
                else{
                    console.log("Empty")
                }
            }).catch((error)=>{
                console.error(error);
            })
        }

*/
        addBookButton.addEventListener('click', addBook);
        findBookButton.addEventListener('click', findBook);
        removeBookButton.addEventListener('click', removeBook);

        
        //user login/logout
        const logInBtn = document.getElementById('logInBtn')
        const logOutBtn = document.getElementById('logOutBtn')

        function signIn(){
            console.log("hello");
            const provider = new GoogleAuthProvider();
            auth.signInWithPopup(provider).then((rel)=>{
                console.log(rel)
            }).catch((err => {
                console.log(err)
            }))
        }

        function signOut(){
            auth.signOut()
        }

        logInBtn.onclick = () => signIn()
        logOutBtn.onclick = () => signOut()
      </script>
</html>