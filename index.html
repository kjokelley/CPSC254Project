<!DOCTYPE html>
<html>
    <head>
        <style>label{display: inline-block; width: 80px}</style>
    </head>
    <body>

        <header class="header">
            <h1>My Library</h1>
            <div class="logIn">
              <button class="btn" id="logInBtn">Login</button>
            </div>
            <div class="logOut">
              <button class="btn" id="logOutBtn">Log out</button>
            </div>
        </header>


        <label>Name</label> <input id="NameBox" type="text">
        <label>Author</label> <input id="AuthorBox" type="text">
        <label>Year Published</label> <input id="YearBox" type="text">

        <br>
        <button id="addBookBtn" type="button"> Add new Book</button>
        <br>
        <button id="findBookBtn" type="button">Find Book</button>
        <br>
        <button id="removeBookBtn" type="button">Remove Book</button>
        <br>
        <button id="loadFullLibrary" type="button">Load Full Library</button>
        <p id="bookName">Enter above to add, remove, or find a book!</p>


        <table>
            <thead>
                <tr>
                    <th> Title  </th>
                    <th> Author </th>
                    <th> Year Published </th>
                    <th> Copies Available </th>
                </tr>
            </thead>
            <tbody id="data-output">
    
            </tbody>
        </table>


    </body>

<script type="module"> 
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, update, DataSnapshot, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDomy_iTgvqoDAFqJmU1sjLditwOKFdf_o",
          authDomain: "cpsc254library.firebaseapp.com",
          projectId: "cpsc254library",
          storageBucket: "cpsc254library.appspot.com",
          messagingSenderId: "783490531388",
          appId: "1:783490531388:web:bfe47ed7a478703f52c339",
          measurementId: "G-T5TJPH6M0G",
          //databaseURL: "https://cpsc254library-default-rtdb.firebaseio.com"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase();

        
        var addBookButton = document.getElementById("addBookBtn");
        var findBookButton = document.getElementById("findBookBtn");
        var removeBookButton = document.getElementById("removeBookBtn");
        var loadButton = document.getElementById("loadFullLibrary");


        var name = document.getElementById("NameBox");
        var author = document.getElementById("AuthorBox");
        var year = document.getElementById("YearBox");
        var copies = 0;
        
        function addBook(){
            if(name.value == "" || author.value == "" || year.value ==""){
                document.getElementById("bookName").innerHTML = "All values must be filled...";
            }
            else{
                get(child(ref(database), 'Books/'+ name.value +'/copies')).then((snapshot)=>{
                    if(snapshot.exists()){
                        console.log(snapshot.val());
                        copies = snapshot.val() + 1; 
                    }
                    else{
                        copies = 1;
                    }
                    set(ref(database, 'Books/' + name.value), {
                        name: name.value,
                        author: author.value,
                        year: year.value,
                        copies: copies
                    })
                    .then(()=>{
                        console.log("Book Added")
                    })
                    .catch((error)=>{
                        alert("unsuccessful");
                    })
                    findBook();
                }).catch((error)=>{
                    console.error(error);
                })
            }
        }

        function findBook(){
            if(name.value == ""){
                document.getElementById("bookName").innerHTML = "Name must be filled...";
            }
            else{
                let libraryTable = document.querySelector("#data-output");
                const dbref = ref(database)
                get(child(dbref, 'Books/' + name.value)).then((snapshot)=> {
                if(snapshot.exists()){
                    ClearAllData();
                    let out = `
                    <tr>
                        <td>${name.value}</td>
                        <td>${snapshot.val().author}</td>
                        <td>${snapshot.val().year}</td>
                        <td>${snapshot.val().copies}</td>
                    </tr>  
                    `;
                    libraryTable.innerHTML = out;
                }
                else{
                    console.log("Unavailable")
                    document.getElementById("bookName").innerHTML = "Unavailable";
                }
                }).catch((error) => {
                    console.error(error);
                })
            }
        }

        function removeBook(){
            if(name.value == ""){
                document.getElementById("bookName").innerHTML = "Name must be filled...";
            }
            else{
                get(child(ref(database), 'Books/'+ name.value)).then((snapshot)=>{
                if(snapshot.exists()){
                    copies = snapshot.val().copies; 
                }
                else{
                    console.log("Empty")
                }

                if(copies == 0){
                    console.log("No More Copies")
                }
                else{
                copies -= 1;
                set(ref(database, 'Books/' + name.value), {
                    name: name.value,
                    author: snapshot.val().author,
                    year: snapshot.val().year,
                    copies: copies
                })
                .then(()=>{
                    console.log("Book Removed");
                })
                .catch((error)=>{
                    alert("unsuccessful");
                })
                findBook();
            }
            }).catch((error)=>{
                console.error(error);
            })
            }
        }

        function FetchAllData(){
            get(child(ref(database), 'Books/')).then((snapshot)=>{
                let libraryTable = document.querySelector("#data-output");
                let out = "";
                snapshot.forEach(
                    function(Childsnapshot){
                        let name = Childsnapshot.val().name;
                        let author = Childsnapshot.val().author;
                        let year = Childsnapshot.val().year;
                        let copies = Childsnapshot.val().copies;
                        out += `
                        <tr>
                            <td>${name}</td>
                            <td>${author}</td>
                            <td>${year}</td>
                            <td>${copies}</td>
                        </tr>  
                        `;
                    }
                )
                libraryTable.innerHTML = out;
            })
        }

        function ClearAllData(){
            let libraryTable = document.querySelector("#data-output");
            libraryTable.innerHTML = "";
        }


        window.onload = FetchAllData();


        addBookButton.addEventListener('click', addBook);
        findBookButton.addEventListener('click', findBook);
        removeBookButton.addEventListener('click', removeBook);
        loadButton.addEventListener('click', FetchAllData);

        
        //user login/logout
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const logInBtn = document.getElementById('logInBtn')
        const logOutBtn = document.getElementById('logOutBtn')


        const userSignIn = async() => {
            signInWithPopup(auth, provider).then((result) => {
                const user = result.user
                console.log(user);
            }).catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message
            })
        }


        const userSignOut = async() => {
            signOut(auth).then(() => {
                alert("You have signed out successfully")
            }).catch((error) => {})
        }

        logInBtn.addEventListener("click", userSignIn);
        logOutBtn.addEventListener("click", userSignOut);

      </script>

</html>